<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--NOTICE: Please open this file in your web browser. If presented with a security warning, you may safely tell it to allow the blocked content.-->
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD.\nAlthough MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD.\nNo support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="https://www.phpbb.com/mods/xml/modx-1.2.6.xsd">
	<header>
		<meta name="generator" content="MODX file generated with PP MODX Creator by tumba25 (online version)"/>
		<meta name="generator" content="MODX file generated by MODX Generator by tumba25"/>
		<license><![CDATA[http://opensource.org/licenses/gpl-license.php GNU General Public License v2]]></license>
		<title lang="en"><![CDATA[Cache guests & bots pages]]></title>
		<title lang="ru"><![CDATA[Кэширование страниц для гостей и ботов]]></title>
		<description lang="en"><![CDATA[Provides ability to cache content of the pages viewed by guests and bots.]]></description>
		<description lang="ru"><![CDATA[Предоставляет возможность кэширования содержимого страниц, просматриваемых гостями и ботами.]]></description>
		<author-group>
			<author>
				<realname><![CDATA[Vitaly Filatenko]]></realname>
				<username><![CDATA[Kot Matroskin]]></username>
				<homepage><![CDATA[http://scooterclub.by]]></homepage>
				<email><![CDATA[kot@hacktest.net]]></email>
			</author>
		</author-group>
		<mod-version>1.1.2</mod-version>
		<installation>
			<level>easy</level>
			<time>300</time>
			<target-version>3.0.11</target-version>
		</installation>
		<history>
      <entry>
        <date>2013-04-05</date>
        <rev-version>1.1.2</rev-version>
        <changelog lang="en">
          <change><![CDATA[Bugfix: write debug info inside <html> tag]]></change>
          <change><![CDATA[Bugfix: optimize hook_cgp.php, improve compatibility]]></change>
        </changelog>
        <changelog lang="ru">
          <change><![CDATA[Bugfix: вывести отладочную информацию внутри <html> тэга]]></change>
          <change><![CDATA[Bugfix: оптимизировать hook_cgp.php, улучшить совместимость]]></change>
        </changelog>
      </entry>
      <entry>
        <date>2013-03-12</date>
        <rev-version>1.1.1</rev-version>
        <changelog lang="en">
          <change><![CDATA[Bugfix: file cache cleanup doesn't work if the mod uses different cache type than system (forum) cache]]></change>
        </changelog>
        <changelog lang="ru">
          <change><![CDATA[Bugfix: очистка кэша не работает когда тип кэша, используеый модом, отличается от системного (форумного) кэша]]></change>
        </changelog>
      </entry>
      <entry>
				<date>2013-03-08</date>
				<rev-version>1.1.0</rev-version>
				<changelog lang="en">
					<change><![CDATA[Returned compatibility with HTTP Guests cache mod]]></change>
					<change><![CDATA[Possibility to use different cache types for a forum and for the mod]]></change>
					<change><![CDATA[Support mod Version Check]]></change>
					<change><![CDATA[Add-on: Hide current time displaying for guests]]></change>
				</changelog>
				<changelog lang="ru">
					<change><![CDATA[Возвращена совместимость с модом HTTP Guests cache]]></change>
					<change><![CDATA[Возможность использовать разные типы кэша для форума и для мода]]></change>
					<change><![CDATA[Поддержка мода Version Check]]></change>
					<change><![CDATA[Add-on: Скрыть показ текущего времени для гостей]]></change>
				</changelog>
			</entry>
			<entry>
				<date>2013-02-24</date>
				<rev-version>1.0.0</rev-version>
				<changelog lang="en">
					<change><![CDATA[Improve HTTP caching by adding ETag/If-None-Match functionality]]></change>
					<change><![CDATA[No need for compatibility with HTTP Guest cache mod anymore]]></change>
					<change><![CDATA[Remove session identifiers for guests (hookable)]]></change>
				</changelog>
				<changelog lang="ru">
					<change><![CDATA[Улучшение HTTP кэширования путём добавления ETag/If-None-Match]]></change>
					<change><![CDATA[Больше нет необходимости в обеспечении совместимости с модом HTTP Guest cache]]></change>
					<change><![CDATA[Удаление идентификаторов сессий для гостей (hookable)]]></change>
				</changelog>
			</entry>
			<entry>
				<date>2013-02-17</date>
				<rev-version>0.4.1</rev-version>
				<changelog lang="en">
					<change><![CDATA[Fixed php warning for bots]]></change>
				</changelog>
				<changelog lang="ru">
					<change><![CDATA[Исправлен php warning у ботов]]></change>
				</changelog>
			</entry>
			<entry>
				<date>2013-02-16</date>
				<rev-version>0.4.0</rev-version>
				<changelog lang="en">
					<change><![CDATA[Fixed error when posts moving doesn't work]]></change>
					<change><![CDATA[Don't cache pages with cron calls within]]></change>
					<change><![CDATA[Admin page: warning on wrong cache type]]></change>
				</changelog>
				<changelog lang="ru">
					<change><![CDATA[Исправлена ошибка с неработоспособностью перемещения сообщений]]></change>
					<change><![CDATA[Не кешировать сраницы с вызовом cron]]></change>
					<change><![CDATA[Админка: предупреждение при неподходящем типе кэша]]></change>
				</changelog>
			</entry>
			<entry>
				<date>2013-02-15</date>
				<rev-version>0.3.0</rev-version>
				<changelog lang="en">
					<change><![CDATA[Added cache size information to admin page]]></change>
					<change><![CDATA[Added compatibility with HTTP Guests cache mod]]></change>
				</changelog>
				<changelog lang="ru">
					<change><![CDATA[В админ-страницу добавлена информация о размере кэша]]></change>
					<change><![CDATA[Добавлена совместимость с модом HTTP Guests cache mod]]></change>
				</changelog>
			</entry>
			<entry>
				<date>2013-02-13</date>
				<rev-version>0.2.0</rev-version>
				<changelog lang="en">
					<change><![CDATA[Initial release]]></change>
				</changelog>
				<changelog lang="ru">
					<change><![CDATA[Первая сборка]]></change>
				</changelog>
			</entry>
		</history>
		<link-group>
			<link type="contrib" href="contrib/board3portal.xml" lang="en">Enable caching for Board3 Portal</link>
			<link type="contrib" href="contrib/addon_hide_current_time.xml" lang="en">Add-on: Hide current time displaying for guests</link>
			<link type="contrib" href="contrib/from_0.2.0-0.3.0_to_1.0.0.xml" lang="en">Upgrade from 0.2.0-0.3.0 to 1.0.0</link>
			<link type="contrib" href="contrib/from_0.4.0_to_1.0.0.xml" lang="en">Upgrade from 0.4.0 to 1.0.0</link>
			<link type="contrib" href="contrib/from_0.4.1_to_1.0.0.xml" lang="en">Upgrade from 0.4.1 to 1.0.0</link>
			<link type="contrib" href="contrib/from_1.0.0-1.1.0_to_1.1.2.xml" lang="en">Upgrade from 1.0.0-1.1.0 to 1.1.2</link>
			<link type="contrib" href="contrib/from_1.1.1_to_1.1.2.xml" lang="en">Upgrade from 1.1.1 to 1.1.2</link>
		</link-group>
	</header>
	<action-group>
		<copy>
			<file from="root/*.*" to="*.*"/>
		</copy>
		<open src=".htaccess">
			<edit>
				<find><![CDATA[#RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization},L]]]></find>
				<action type="after-add"><![CDATA[#</IfModule>

#
# Uncomment the statement below if your PHP running as a CGI
# and you have no access to If-Modified-Since/If-None-Match request headers
#
#<IfModule mod_rewrite.c>
#RewriteEngine on
#RewriteRule .* - [E=HTTP_IF_MODIFIED_SINCE:%{HTTP:If-Modified-Since}]
#RewriteRule .* - [E=HTTP_IF_NONE_MATCH:%{HTTP:If-None-Match}]]]></action>
			</edit>
		</open>
		<open src="cron.php">
			<edit>
				<find><![CDATA[		$cache->tidy();]]></find>
				<action type="after-add"><![CDATA[
	break;

	case 'cgp_tidy_cache':

		if (!class_exists('CGP'))
		{
			include($phpbb_root_path . 'includes/cache_guests_pages.' . $phpEx);
		}

		if (time() - $config['cgp_cache_gc'] <= $config['cgp_cache_last_gc'] || !method_exists(CGP::$cache, 'tidy'))
		{
			break;
		}

		CGP::$cache->tidy();]]></action>
			</edit>
		</open>
		<open src="index.php">
			<edit>
				<find><![CDATA[$auth->acl($user->data);]]></find>
				<action type="after-add"><![CDATA[
//-- BEGIN Cache page content for guests
if (!class_exists('CGP'))
{
	include($phpbb_root_path . 'includes/cache_guests_pages.' . $phpEx);
}

if (defined('CGP_ENABLED'))
{
	if (CGP::is_cacheable_user($user))
	{
		define('CGP_KEY', '_index' . CGP::user_type_suffix($user));

		CGP::display_if_cached(CGP_KEY);
	}
}
//-- END Cache page content for guests
]]></action>
			</edit>
		</open>
		<open src="posting.php">
			<edit>
				<find><![CDATA[include($phpbb_root_path . 'includes/message_parser.' . $phpEx);]]></find>
				<action type="after-add"><![CDATA[//-- BEGIN Cache page content for guests
if (!class_exists('CGP'))
{
	include($phpbb_root_path . 'includes/cache_guests_pages.' . $phpEx);
}
//-- END Cache page content for guests]]></action>
			</edit>
			<edit>
				<find><![CDATA[			$meta_info = ($mode == 'post') ? append_sid("{$phpbb_root_path}viewforum.$phpEx", 'f=' . $forum_id) : append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$forum_id&amp;t=$topic_id");]]></find>
				<action type="after-add"><![CDATA[			//-- BEGIN Cache page content for guests
			if (defined('CGP_ENABLED')) CGP::destroy_topic_cache($topic_id, $post_data);
			//-- END Cache page content for guests
			]]></action>
			</edit>
			<edit>
				<find><![CDATA[				$captcha->reset();
			}]]></find>
				<action type="after-add"><![CDATA[
			//-- BEGIN Cache page content for guests
			if (defined('CGP_ENABLED')) CGP::destroy_topic_cache($topic_id, $post_data);
			//-- END Cache page content for guests]]></action>
			</edit>
			<edit>
				<find><![CDATA[				$message = $user->lang['POST_DELETED'] . '<br /><br />' . sprintf($user->lang['RETURN_TOPIC'], '<a href="' . $meta_info . '">', '</a>');
			}]]></find>
				<action type="after-add"><![CDATA[
			//-- BEGIN Cache page content for guests
			if (defined('CGP_ENABLED')) CGP::destroy_topic_cache($topic_id, $post_data);
			//-- END Cache page content for guests]]></action>
			</edit>
		</open>
		<open src="viewforum.php">
			<edit>
				<find><![CDATA[$sort_dir	= request_var('sd', $default_sort_dir);]]></find>
				<action type="after-add"><![CDATA[
//-- BEGIN Cache page content for guests
if (!class_exists('CGP'))
{
	include($phpbb_root_path . 'includes/cache_guests_pages.' . $phpEx);
}

if (defined('CGP_ENABLED'))
{
	// process typical cases only to prevent cache size exploding
	if (CGP::is_cacheable_user($user) && 
		$forum_id &&
		$sort_days == $default_sort_days &&
		$sort_key == $default_sort_key &&
		$sort_dir == $default_sort_dir)
	{
		define('CGP_KEY', "_vf_f{$forum_id}_s{$start}" . CGP::user_type_suffix($user));

		CGP::display_if_cached(CGP_KEY);
	}
}
//-- END Cache page content for guests]]></action>
			</edit>
		</open>
		<open src="viewtopic.php">
			<edit>
				<find><![CDATA[	$start = ($start < 0) ? 0 : floor(($total_posts - 1) / $config['posts_per_page']) * $config['posts_per_page'];
}]]></find>
				<action type="after-add"><![CDATA[
//-- BEGIN Cache page content for guests
if (!class_exists('CGP'))
{
	include($phpbb_root_path . 'includes/cache_guests_pages.' . $phpEx);
}

if (defined('CGP_ENABLED'))
{
	// process typical cases only to prevent cache size exploding
	if (CGP::is_cacheable_user($user) && 
		$topic_id && !$view && !$update &&
		$sort_days == $default_sort_days &&
		$sort_key == $default_sort_key &&
		$sort_dir == $default_sort_dir)
	{
		define('CGP_KEY', "_vt_t{$topic_id}_s{$start}" . CGP::user_type_suffix($user));

		CGP::display_if_cached(CGP_KEY);
	}
}
//-- END Cache page content for guests]]></action>
			</edit>
		</open>
		<open src="includes/functions.php">
			<edit>
				<find><![CDATA[			ob_start('ob_gzhandler');
		}]]></find>
				<action type="after-add"><![CDATA[	}
	elseif (defined('CGP_KEY') && !headers_sent() && ob_get_level() <= 1 && ob_get_length() == 0)
	{
		// we have to use output buffer for saving cached content
		ob_start();]]></action>
			</edit>
			<edit>
				<find><![CDATA[	global $db, $config, $template, $user, $auth, $cache, $starttime, $phpbb_root_path, $phpEx;]]></find>
				<action type="after-add"><![CDATA[	//-- BEGIN Cache page content for guests
	global $acm_type;
	//-- END Cache page content for guests]]></action>
			</edit>
			<edit>
				<find><![CDATA[			$cron_type = 'tidy_sessions';]]></find>
				<action type="after-add"><![CDATA[		}
		// Perform custom cache tidy if not system cache used
		else if ($acm_type != 'file' && $config['cgp_force_fcache'] && 
			$time_now - $config['cgp_cache_gc'] > $config['cgp_cache_last_gc'])
		{
			// Tidy the cache
			$cron_type = 'cgp_tidy_cache';]]></action>
			</edit>
			<edit>
				<find><![CDATA[	$template->display('body');]]></find>
				<action type="after-add"><![CDATA[
	//-- BEGIN Cache page content for guests
	if (defined('CGP_KEY') && (!isset($cron_type) || !$cron_type)) // don't cache pages with cron calls
	{
		if (!class_exists('CGP'))
		{
			include($phpbb_root_path . 'includes/cache_guests_pages.' . $phpEx);
		}
		
		if (isset($config['cgp_ttl'])) // should be defined as well as CGP_KEY... but why not to check before using?
		{
			CGP::cache_content_page(CGP_KEY, $config['cgp_ttl']);
		}
		else
		{
			CGP::cache_content_page(CGP_KEY);
		}
	}
	//-- END Cache page content for guests]]></action>
			</edit>
		</open>
		<open src="includes/functions_admin.php">
			<edit>
				<find><![CDATA[}]]></find>
				<action type="after-add"><![CDATA[
//-- BEGIN Cache page content for guests
if (!class_exists('CGP'))
{
	include($phpbb_root_path . 'includes/cache_guests_pages.' . $phpEx);
}
//-- END Cache page content for guests]]></action>
			</edit>
			<edit>
				<find><![CDATA[		$topic_ids = array($topic_ids);
	}]]></find>
				<action type="after-add"><![CDATA[
	//-- BEGIN Cache page content for guests
	if (defined('CGP_ENABLED')) 
	{
		foreach ($topic_ids as $t_id)
		{
			CGP::destroy_topic_cache($t_id);
		}
		
		foreach ($forum_ids as $f_id)
		{
			CGP::destroy_forum_cache($f_id);
		}
	}
	//-- END Cache page content for guests]]></action>
			</edit>
			<edit>
				<find><![CDATA[		$topic_ids[] = (int) $row['topic_id'];
	}
	$db->sql_freeresult($result);]]></find>
				<action type="after-add"><![CDATA[
	//-- BEGIN Cache page content for guests
	if (defined('CGP_ENABLED')) 
	{
		foreach ($topic_ids as $t_id)
		{
			CGP::destroy_topic_cache($t_id);
		}
	}
	//-- END Cache page content for guests]]></action>
			</edit>
			<edit>
				<find><![CDATA[		return $return;
	}]]></find>
				<action type="after-add"><![CDATA[
	//-- BEGIN Cache page content for guests
	if (defined('CGP_ENABLED')) 
	{
		foreach ($topic_ids as $t_id)
		{
			CGP::destroy_topic_cache($t_id);
		}
	}
	//-- END Cache page content for guests]]></action>
			</edit>
			<edit>
				<find><![CDATA[	if (sizeof($moved_topic_ids))
	{]]></find>
				<action type="after-add"><![CDATA[		//-- BEGIN Cache page content for guests
		if (defined('CGP_ENABLED')) 
		{
			foreach ($forum_ids as $f_id)
			{
				CGP::destroy_forum_cache($f_id);
			}
		}
		//-- END Cache page content for guests
	]]></action>
			</edit>
			<edit>
				<find><![CDATA[	$db->sql_freeresult($result);]]></find>
				<action type="after-add"><![CDATA[
	//-- BEGIN Cache page content for guests
	if (defined('CGP_ENABLED')) 
	{
		foreach ($topic_ids as $t_id)
		{
			CGP::destroy_topic_cache($t_id);
		}
	}
	//-- END Cache page content for guests]]></action>
			</edit>
		</open>
		<open src="includes/mcp/mcp_main.php">
			<edit>
				<find><![CDATA[}]]></find>
				<action type="after-add"><![CDATA[
//-- BEGIN Cache page content for guests
if (!class_exists('CGP'))
{
	include($phpbb_root_path . 'includes/cache_guests_pages.' . $phpEx);
}
//-- END Cache page content for guests]]></action>
			</edit>
			<edit>
				<find><![CDATA[		$data = ($action == 'lock' || $action == 'unlock') ? get_topic_data($ids) : get_post_data($ids);]]></find>
				<action type="after-add"><![CDATA[
		//-- BEGIN Cache page content for guests
		// no need to refresh topic cache for posts locking
		if (defined('CGP_ENABLED') && ($action == 'lock' || $action == 'unlock')) 
		{
			foreach ($ids as $t_id)
			{
				CGP::destroy_topic_cache($t_id, $data[$t_id]);
			}
		}
		//-- END Cache page content for guests]]></action>
			</edit>
			<edit>
				<find><![CDATA[				add_log('mod', $forum_id, $topic_id, 'LOG_TOPIC_TYPE_CHANGED', $row['topic_title']);]]></find>
				<action type="after-add"><![CDATA[				
				//-- BEGIN Cache page content for guests
				if (defined('CGP_ENABLED'))
				{
					CGP::destroy_topic_cache($topic_id, $row);
				}
				//-- END Cache page content for guests]]></action>
			</edit>
			<edit>
				<find><![CDATA[		$sync_sql[$to_forum_id][]	= 'forum_topics_real = forum_topics_real + ' . sizeof($new_topic_id_list);

		foreach ($sync_sql as $forum_id_key => $array)
		{
			$sql = 'UPDATE ' . FORUMS_TABLE . '
				SET ' . implode(', ', $array) . '
				WHERE forum_id = ' . $forum_id_key;
			$db->sql_query($sql);
		}]]></find>
				<action type="after-add"><![CDATA[
		//-- BEGIN Cache page content for guests
		if (defined('CGP_ENABLED')) 
		{
			CGP::destroy_forum_cache($to_forum_id);
		}
		//-- END Cache page content for guests]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/template/overall_footer.html">
			<edit>
				<find><![CDATA[		<!-- IF DEBUG_OUTPUT --><br />{DEBUG_OUTPUT}<!-- ENDIF -->]]></find>
				<inline-edit>
					<inline-find><![CDATA[		<!-- IF DEBUG_OUTPUT --><br />{DEBUG_OUTPUT}<!-- ]]></inline-find>
					<inline-action type="after-add"><![CDATA[CGP DEBUG OUTPUT --><!-- ]]></inline-action>
				</inline-edit>
			</edit>
		</open>
		<php-installer><![CDATA[install/index.php]]></php-installer>
		<diy-instructions lang="en"><![CDATA[Don't forget to remove install folder after completing the installation.

Additional settings recommendations:
- it is recommended to use file cache type due to large amount of cached data;
- disable guests' quick reply ability if any mod enables it (to avoid captcha related problems);
- uncomment corresponding lines in .htaccess, if PHP does not installed as Apache module (and if you have no access to HTTP header If-None-Match);
- to increase productivity use this mod together with HTTP Guest Cache mod: https://www.phpbb.com/community/viewtopic.php?f=70&t=2171266]]></diy-instructions>
		<diy-instructions lang="ru"><![CDATA[Не забудьте удалить папку install после завершения установки.

Рекомендации по дополнительной настройке:

- желательно использовать файловый кэш по причине больших объёмов закэшированных данных;
- обязательно отключите возможность быстрого ответа для гостей, если какой-то мод её включает (во избежание проблем с капчей);
- раскомментируйте соответствующие строки в .htaccess, если PHP не установлен как модуль Apache (и если нет доступа к HTTP заголовку If-None-Match);
- более эффективных результатов можно добиться используя этот мод совместно с модом HTTP Guest Cache: https://www.phpbb.com/community/viewtopic.php?f=70&t=2171266]]></diy-instructions>
	</action-group>
</mod>
